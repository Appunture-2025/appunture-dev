# =============================================================================
# Copilot Coding Agent - Automated Issue Creation
# =============================================================================
# Este workflow cria Issues que o GitHub Copilot Coding Agent pode processar.
# O Copilot Coding Agent funciona via Issues/PRs, NÃƒO via CLI no CI/CD.
#
# Como funciona:
# 1. Este workflow cria issues com label "copilot-agent"
# 2. VocÃª (ou o workflow) menciona @github-copilot na issue
# 3. O Copilot Coding Agent processa e cria um PR automaticamente
#
# PrÃ©-requisitos:
# - Copilot Coding Agent habilitado no repositÃ³rio (Settings > Copilot > Coding Agent)
# - PermissÃµes de workflow para criar issues
# =============================================================================

name: Copilot Agent Nightly

on:
  schedule:
    - cron: "0 2 * * *" # Executa Ã s 02:00 UTC diariamente
  workflow_dispatch:
    inputs:
      prompt_filter:
        description: "Filtro para prompts (ex: backend, frontend, ou vazio para todos)"
        required: false
        default: ""

permissions:
  contents: read
  issues: write

jobs:
  create-agent-issues:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Create or update copilot-agent label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh label create "copilot-agent" \
            --description "Issues para o Copilot Coding Agent processar" \
            --color "7057ff" \
            --force || true

      - name: Create Issues for Copilot Coding Agent
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PROMPT_FILTER: ${{ github.event.inputs.prompt_filter }}
        run: |
          DATE=$(date +%Y-%m-%d)

          for prompt_file in automation/prompts/*.md; do
            PROMPT_NAME=$(basename "$prompt_file" .md)
            
            # Aplica filtro se especificado
            if [ -n "$PROMPT_FILTER" ] && [[ "$PROMPT_NAME" != *"$PROMPT_FILTER"* ]]; then
              echo "Pulando: $PROMPT_NAME (nao corresponde ao filtro)"
              continue
            fi
            
            PROMPT_CONTENT=$(cat "$prompt_file")
            
            # Verifica se ja existe issue aberta com esse prompt
            EXISTING=$(gh issue list --label "copilot-agent" --state open --search "in:title $PROMPT_NAME" --json number --jq '.[0].number // empty')
            
            if [ -n "$EXISTING" ]; then
              echo "Issue ja existe para: $PROMPT_NAME (issue #$EXISTING)"
              continue
            fi
            
            echo "Criando issue para: $PROMPT_NAME"
            
            # Cria arquivo temporario com o body da issue
            cat > /tmp/issue_body.md << 'ENDOFBODY'
          ## Tarefa para Copilot Coding Agent

          ENDOFBODY
            
            # Adiciona conteudo do prompt
            echo "" >> /tmp/issue_body.md
            cat "$prompt_file" >> /tmp/issue_body.md
            
            # Adiciona instrucoes
            cat >> /tmp/issue_body.md << ENDOFINSTRUCTIONS

          ---

          ### Instrucoes para o Agent

          Copilot, por favor execute as tarefas descritas acima neste repositorio.
          Crie um Pull Request com todas as alteracoes quando concluir.

          ### Contexto
          - **Prompt**: $PROMPT_NAME
          - **Data**: $DATE
          - **Gerado por**: Workflow copilot-agent-nightly

          ### Checklist esperado
          - [ ] Codigo implementado conforme o prompt
          - [ ] Testes criados/atualizados
          - [ ] Documentacao atualizada se necessario
          - [ ] PR criado com descricao clara
          ENDOFINSTRUCTIONS
            
            gh issue create \
              --title "[Copilot Agent] $PROMPT_NAME - $DATE" \
              --body-file /tmp/issue_body.md \
              --label "copilot-agent" \
              || echo "Falha ao criar issue para $PROMPT_NAME"
              
            # Pequena pausa para evitar rate limiting
            sleep 2
          done

      - name: Summary of created issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸ“‹ RESUMO - Issues para Copilot Agent"
          echo "=========================================="
          echo ""
          gh issue list --label "copilot-agent" --state open --limit 20
          echo ""
          echo "=========================================="
          echo "ðŸ’¡ PRÃ“XIMOS PASSOS:"
          echo "=========================================="
          echo "1. Acesse cada issue criada"
          echo "2. Verifique se o Copilot Coding Agent estÃ¡ ativo no repo"
          echo "3. Se necessÃ¡rio, comente '@github-copilot' na issue"
          echo "4. O Copilot criarÃ¡ PRs automaticamente"
          echo "==========================================""
