sequenceDiagram
    participant App as App Mobile
    participant SQLite as SQLite Local
    participant Net as Network Monitor
    participant API as Backend API
    participant DB as Firestore

    Note over App, DB: Sincronizacao Automatica

    Net->>App: Evento: Conexao restaurada
    App->>App: Iniciar sincronizacao

    App->>SQLite: SELECT FROM sync_status WHERE synced = false
    SQLite-->>App: Lista de operacoes pendentes

    loop Para cada operacao pendente
        App->>API: Enviar operacao (POST/PUT/DELETE)
        API->>DB: Aplicar no Firestore
        DB-->>API: Confirmacao
        API-->>App: OK
        App->>SQLite: UPDATE SET synced = true
    end

    Note over App, DB: Pull de Dados do Servidor

    App->>SQLite: SELECT MAX(lastSync) FROM sync_metadata
    SQLite-->>App: Timestamp da ultima sync

    App->>API: GET /api/sync?since={lastSync}
    API->>DB: Query por updatedAt > lastSync
    DB-->>API: Documentos modificados
    API-->>App: Delta de alteracoes

    loop Para cada item no delta
        App->>App: Verificar conflito
        alt Sem conflito
            App->>SQLite: UPSERT dados
        else Conflito
            App->>App: Last-write-wins
            App->>SQLite: Atualizar
        end
    end

    App->>SQLite: UPDATE sync_metadata SET lastSync = NOW()
